<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ“Š å®¶è¨ˆç°¿ v3.4</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#4CAF50">
  <style>
    html, body { margin: 0; padding: 0; font-family: sans-serif; background: #f2f2f2; }
    header { background: #4caf50; color: #fff; text-align: center; padding: 10px; font-size: 1.2em; position: sticky; top: 0; }
    .container { max-width: 480px; margin: 0 auto; padding: 10px; }
    form { display: flex; flex-direction: column; gap: 10px; background: white; padding: 12px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 15px; }
    input, select, button { font-size: 1em; padding: 8px; border-radius: 4px; border: 1px solid #ccc; }
    button { cursor: pointer; }
    .btn-main { background: #4caf50; color: #fff; border: none; }
    .btn-sub { background: #555; color: #fff; border: none; }
    .btn-group { display: flex; flex-wrap: wrap; gap: 5px; justify-content: space-between; margin-bottom: 10px; }
    .list, .summary { background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); padding: 10px; margin-top: 15px; }
    .entry { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding: 6px 0; }
    .delete-btn { background: #e74c3c; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 0.8em; }
  </style>
</head>
<body>
<header>ğŸ“Š å®¶è¨ˆç°¿ v3.4ï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œï¼‰</header>
<div class="container">
  <form id="expense-form">
    <label>æ—¥ä»˜ã¨æ™‚é–“</label>
    <input type="datetime-local" id="datetime" required>

    <label>ãŠåº—</label>
    <select id="store" required>
      <optgroup label="ã‚³ãƒ³ãƒ“ãƒ‹">
        <option>ã‚»ãƒ–ãƒ³ã‚¤ãƒ¬ãƒ–ãƒ³</option><option>ãƒ•ã‚¡ãƒŸãƒªãƒ¼ãƒãƒ¼ãƒˆ</option><option>ãƒ­ãƒ¼ã‚½ãƒ³</option><option>ã¾ã„ã°ã™ã‘ã£ã¨</option><option>ãƒŸãƒ‹ã‚¹ãƒˆãƒƒãƒ—</option>
      </optgroup>
      <optgroup label="ã‚¹ãƒ¼ãƒ‘ãƒ¼">
        <option>æ±æ€¥ã‚¹ãƒˆã‚¢</option><option>ãƒãƒ«ã‚¨ãƒ„</option><option>è¥¿å‹</option><option>ãƒ‰ãƒ³ã‚­ãƒ›ãƒ¼ãƒ†</option><option>ä¸‰å’Œ</option>
      </optgroup>
      <optgroup label="ãƒ‰ãƒ©ãƒƒã‚°ã‚¹ãƒˆã‚¢">
        <option>HAC</option><option>ã‚¦ã‚§ãƒ«ã‚·ã‚¢</option><option>ãƒãƒ„ãƒ¢ãƒˆã‚­ãƒ¨ã‚·</option><option>ã‚³ã‚³ã‚«ãƒ©ãƒ•ã‚¡ã‚¤ãƒ³</option>
      </optgroup>
      <optgroup label="ç™¾å‡">
        <option>ãƒ€ã‚¤ã‚½ãƒ¼</option><option>Seria</option><option>Canâ˜…Do</option>
      </optgroup>
    </select>

    <label>é‡‘é¡ï¼ˆå††ï¼‰</label>
    <input type="number" id="amount" required placeholder="ä¾‹: 1250">

    <div class="btn-group">
      <button type="submit" class="btn-main">è¿½åŠ ã™ã‚‹</button>
      <button type="button" id="clear-btn" class="btn-sub">ã‚¯ãƒªã‚¢</button>
    </div>
  </form>

  <div class="btn-group">
    <button id="daily-btn">ğŸ“… æ—¥åˆ¥</button>
    <button id="store-btn">ğŸª åº—èˆ—åˆ¥</button>
    <button id="month-btn">ğŸ“† æœˆæ¬¡</button>
    <button id="year-btn">ğŸ“Š å¹´æ¬¡</button>
  </div>

  <div id="expense-list" class="list"></div>
  <div class="summary">
    <h3>é›†è¨ˆçµæœ</h3>
    <div id="summary-content"></div>
  </div>
</div>

<script>
/* IndexedDB è¨­å®š */
let db;
const dbName = "kakeiboDB";
const storeName = "expenses";

const openDB = () => new Promise((resolve, reject) => {
  const req = indexedDB.open(dbName, 1);
  req.onupgradeneeded = e => {
    const db = e.target.result;
    db.createObjectStore(storeName, { keyPath: "id" });
  };
  req.onsuccess = e => resolve(e.target.result);
  req.onerror = e => reject(e.target.error);
});

const getAll = async () => {
  const tx = db.transaction(storeName, "readonly");
  const store = tx.objectStore(storeName);
  return new Promise((resolve, reject) => {
    const req = store.getAll();
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
};

const saveItem = async item => {
  const tx = db.transaction(storeName, "readwrite");
  tx.objectStore(storeName).put(item);
};

const deleteItem = async id => {
  const tx = db.transaction(storeName, "readwrite");
  tx.objectStore(storeName).delete(id);
};

/* æç”»ãƒ»é›†è¨ˆ */
const listEl = document.getElementById("expense-list");
const summaryEl = document.getElementById("summary-content");
let expenses = [];

const renderList = () => {
  listEl.innerHTML = "";
  if (!expenses.length) {
    listEl.innerHTML = "<p style='text-align:center;color:#666;'>ãƒ‡ãƒ¼ã‚¿ãªã—</p>";
    return;
  }
  expenses.sort((a,b)=>new Date(b.datetime)-new Date(a.datetime))
    .forEach(e=>{
      const div=document.createElement("div");
      div.className="entry";
      div.innerHTML=`<div><b>${e.store}</b><br>${e.datetime}<br>Â¥${Number(e.amount).toLocaleString()}</div>
                     <button class="delete-btn">å‰Šé™¤</button>`;
      div.querySelector(".delete-btn").addEventListener("click", async()=>{
        await deleteItem(e.id);
        expenses = expenses.filter(x=>x.id!==e.id);
        renderList();
      });
      listEl.appendChild(div);
    });
};

const showSummary = (mode) => {
  summaryEl.innerHTML="";
  if(!expenses.length)return;
  const map={};
  for(const e of expenses){
    const d=new Date(e.datetime);
    let key;
    if(mode==="day") key=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
    else if(mode==="month") key=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
    else if(mode==="year") key=`${d.getFullYear()}`;
    else if(mode==="store") key=e.store;
    map[key]=(map[key]||0)+Number(e.amount);
  }
  Object.keys(map).sort().reverse().forEach(k=>{
    summaryEl.innerHTML+=`${k} : Â¥${map[k].toLocaleString()}<br>`;
  });
};

/* ã‚¤ãƒ™ãƒ³ãƒˆ */
document.getElementById("expense-form").addEventListener("submit", async e=>{
  e.preventDefault();
  const datetime=document.getElementById("datetime").value;
  const store=document.getElementById("store").value;
  const amount=parseFloat(document.getElementById("amount").value);
  if(!datetime||!store||!amount)return;
  const item={id:Date.now(),datetime,store,amount};
  await saveItem(item);
  expenses.push(item);
  renderList();
  e.target.reset();
});

document.getElementById("clear-btn").addEventListener("click",()=>{
  document.getElementById("expense-form").reset();
});
document.getElementById("daily-btn").addEventListener("click",()=>showSummary("day"));
document.getElementById("store-btn").addEventListener("click",()=>showSummary("store"));
document.getElementById("month-btn").addEventListener("click",()=>showSummary("month"));
document.getElementById("year-btn").addEventListener("click",()=>showSummary("year"));

/* åˆæœŸåŒ– */
(async()=>{
  db=await openDB();
  expenses=await getAll();
  renderList();
})();
</script>

<script>
// --- PWAå¯¾å¿œï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰---
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./service-worker.js');
}
</script>

</body>
</html>
