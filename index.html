<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>📊 シンプル家計簿（Google Drive版）</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  html, body { margin: 0; padding: 0; font-family: sans-serif; background-color: #f2f2f2; }
  header { background: #4caf50; color: white; text-align: center; padding: 10px; font-size: 1.2em; position: sticky; top: 0; }
  .container { max-width: 480px; margin: 0 auto; padding: 10px; }
  form { display: flex; flex-direction: column; gap: 10px; background: white; padding: 12px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 15px; }
  label { font-size: 0.9em; font-weight: bold; }
  input, select, button { font-size: 1em; padding: 8px; border-radius: 4px; border: 1px solid #ccc; }
  button { background: #4caf50; color: white; border: none; cursor: pointer; }
  button:hover { background: #45a049; }
  .list, .summary { background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); padding: 10px; margin-top: 15px; }
  .entry { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding: 6px 0; }
  .entry:last-child { border-bottom: none; }
  .entry-store { font-weight: bold; }
  .delete-btn { background: #e74c3c; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 0.8em; }
  .delete-btn:hover { background: #c0392b; }
</style>
</head>
<body>
<header>📊 シンプル家計簿（Drive自動保存）</header>
<div class="container">
  <form id="expense-form">
    <label>日付と時間</label>
    <input type="datetime-local" id="datetime" required>

    <label>お店</label>
    <select id="store" required>
      <optgroup label="コンビニ">
        <option>セブンイレブン</option><option>ファミリーマート</option><option>ローソン</option><option>まいばすけっと</option><option>ミニストップ</option><option>ヤマザキ</option><option>その他CS</option>
      </optgroup>
       <optgroup label="スーパー">
        <option>東急ストア</option><option>マルエツ</option><option>西友</option><option>ドンキホーテ</option><option>ダイエー</option><option>三和</option><option>その他SP</option>
      </optgroup>
      <optgroup label="ドラッグストア">
        <option>HAC</option><option>ウェルシア</option><option>マツモトキヨシ</option><option>ココカラファイン</option><option>ツルハ</option><option>その他DS</option>
      </optgroup>
      <optgroup label="百均">
        <option>ダイソー</option><option>Seria</option><option>Can★Do</option><option>その他百均</option>
      </optgroup>
    </select>

    <label>金額（円）</label>
    <input type="number" id="amount" required placeholder="例: 1250">

    <button type="submit">追加する</button>
  </form>

  <div class="list" id="expense-list"></div>
  <div class="summary" id="summary">
    <h3>📅 月別集計</h3><div id="monthly-summary"></div>
    <h3>📆 年別集計</h3><div id="yearly-summary"></div>
  </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbw9zaG2HCfDe79dIYZZWdl3BCQd-_AVaxEdb5W7bRqnIenmtybuKxP2PXKSgOwMk0w/exec";

let expenses = [];

// ✅ Driveからロード
async function loadData() {
  try {
    const res = await fetch(API_URL);
    if (res.ok) {
      expenses = await res.json();
      if (!Array.isArray(expenses)) expenses = [];
    }
  } catch (e) {
    console.error("Load error:", e);
    expenses = [];
  }
  render();
}

// ✅ Driveへ自動保存
async function saveData() {
  try {
    await fetch(API_URL, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(expenses)
    });
  } catch (e) {
    console.error("Save error:", e);
  }
}

document.getElementById("expense-form").addEventListener("submit", e => {
  e.preventDefault();
  const datetime = datetimeInput.value;
  const store = storeSelect.value;
  const amount = parseFloat(amountInput.value);
  if (!datetime || !store || !amount) return;

  expenses.push({ datetime, store, amount });
  saveData();
  render();
  e.target.reset();
});

function render() {
  const list = document.getElementById("expense-list");
  const monthSum = document.getElementById("monthly-summary");
  const yearSum = document.getElementById("yearly-summary");
  list.innerHTML = "";
  monthSum.innerHTML = "";
  yearSum.innerHTML = "";

  if (expenses.length === 0) {
    list.innerHTML = "<p style='text-align:center;color:#666'>データなし</p>";
    return;
  }

  // 一覧
  expenses.sort((a,b)=>new Date(b.datetime)-new Date(a.datetime))
    .forEach((e,i)=>{
      const div=document.createElement("div");
      div.className="entry";
      div.innerHTML=`<div><b>${e.store}</b><br>${formatDate(e.datetime)}<br>¥${e.amount.toLocaleString()}</div>
                     <button class="delete-btn" onclick="del(${i})">削除</button>`;
      list.appendChild(div);
    });

  // 集計
  const m={}; const y={};
  for (const e of expenses){
    const d=new Date(e.datetime);
    const ym=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    m[ym]=(m[ym]||0)+e.amount;
    y[d.getFullYear()]=(y[d.getFullYear()]||0)+e.amount;
  }

  Object.keys(m).sort().reverse().forEach(k=>monthSum.innerHTML+=`${k}<span>¥${m[k].toLocaleString()}</span><br>`);
  Object.keys(y).sort().reverse().forEach(k=>yearSum.innerHTML+=`${k}<span>¥${y[k].toLocaleString()}</span><br>`);
}

function del(i){
  if(!confirm("削除しますか？"))return;
  expenses.splice(i,1);
  saveData();
  render();
}

function formatDate(dt){
  const d=new Date(dt);
  const y=d.getFullYear();
  const m=String(d.getMonth()+1).padStart(2,'0');
  const day=String(d.getDate()).padStart(2,'0');
