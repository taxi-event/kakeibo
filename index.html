<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>📊 家計簿 v3.8（日付指定集計）</title>
<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#4CAF50" />
<style>
  :root{--g:#4caf50;--dx:#e74c3c;--bg:#f6f6f6;--ink:#222}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  header{position:sticky;top:0;z-index:10;background:var(--g);color:#fff;padding:10px 14px;font-weight:700;display:flex;align-items:center;gap:8px}
  .wrap{max-width:520px;margin:0 auto;padding:12px}
  .card{background:#fff;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.08);padding:12px;margin:12px 0}
  label{font-size:.9em;font-weight:700;display:block;margin:8px 0 4px}
  input,select,button{width:100%;font-size:16px;padding:10px;border:1px solid #ddd;border-radius:10px;box-sizing:border-box}
  button{cursor:pointer;border:none}
  .btn-main{background:var(--g);color:#fff}
  .btn-sub{background:#555;color:#fff}
  .btn-danger{background:var(--dx);color:#fff}
  .btns{display:flex;gap:8px;flex-wrap:wrap}
  .tabs{display:flex;gap:8px;flex-wrap:wrap}
  .tabs button{flex:1 1 30%;background:#eee}
  .tabs button.active{background:#d7f3dc}
  .sumline{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px dashed #eee}
  .sumline:last-child{border-bottom:none}
  .entry{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #eee;padding:10px 0}
  .entry:last-child{border-bottom:none}
  .e-left{max-width:74%}
  .muted{color:#777}
  small.badge{background:#eee;border-radius:999px;padding:2px 8px;margin-left:6px}
  .inline{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .inline input[type="date"]{flex:1}
  .pill{background:#eef7f0;color:#1b5e20;padding:4px 8px;border-radius:999px;font-size:12px}
</style>
</head>
<body>
<header>📊 家計簿 v3.8（スマホ単体）</header>
<div class="wrap">

  <!-- 上：集計（タブ＋日付指定） -->
  <div class="card">
    <div class="tabs">
      <button id="tab-day"   class="active">📅 日別</button>
      <button id="tab-month">📆 月別</button>
      <button id="tab-year">📊 年別</button>
      <button id="tab-store">🏪 店別</button>
      <button id="tab-cat">🍱 補足別</button>
      <button id="tab-all">🔁 全件</button>
    </div>

    <!-- 日付指定UI（「日別」アクティブ時のみ使う） -->
    <div class="inline" style="margin-top:8px">
      <span class="pill">任意日集計</span>
      <input id="dayFilter" type="date" />
      <button id="btn-apply-day" class="btn-sub" style="flex:0 0 auto">適用</button>
      <button id="btn-clear-day" class="btn-sub" style="flex:0 0 auto">解除</button>
    </div>

    <div id="summary" style="margin-top:8px"></div>
    <p class="muted" style="margin:6px 0 0">※日付未指定時は「直近3日分」を自動集計</p>
  </div>

  <!-- 中：入力フォーム -->
  <div class="card">
    <label for="dt">日付と時間</label>
    <input id="dt" type="datetime-local" />

    <label for="store">お店</label>
    <select id="store" required>
      <optgroup label="コンビニ">
        <option>セブンイレブン</option><option>ファミリーマート</option><option>ローソン</option>
        <option>まいばすけっと</option><option>ミニストップ</option><option>ヤマザキ</option><option>その他CS</option>
      </optgroup>
      <optgroup label="スーパー">
        <option>東急ストア</option><option>マルエツ</option><option>西友</option><option>ドンキホーテ</option><option>ダイエー</option><option>三和</option><option>その他SP</option>
      </optgroup>
      <optgroup label="ドラッグストア">
        <option>HAC</option><option>ウェルシア</option><option>マツモトキヨシ</option><option>ココカラファイン</option><option>ツルハ</option><option>その他DS</option>
      </optgroup>
      <optgroup label="百均">
        <option>ダイソー</option><option>Seria</option><option>Can★Do</option><option>その他百均</option>
      </optgroup>
    </select>

    <label for="cat">補足</label>
    <select id="cat">
      <option>朝食</option><option>昼食</option><option>夕食</option>
      <option>おやつ</option><option>間食</option><option>飲み物</option>
      <option>ストック</option><option>その他</option>
    </select>

    <label for="amt">金額（円）</label>
    <input id="amt" type="number" inputmode="decimal" placeholder="例：1250" />

    <div class="btns" style="margin-top:10px">
      <button id="btn-add" class="btn-main">追加</button>
      <button id="btn-clear" class="btn-sub">クリア</button>
      <button id="btn-reload" class="btn-sub">再読込</button>
    </div>

    <div class="btns" style="margin-top:8px">
      <button id="btn-export" class="btn-sub">📤 CSV出力</button>
      <input id="file-import" type="file" accept=".csv" style="display:none" />
      <button id="btn-import" class="btn-sub">📥 CSV読込</button>
    </div>
    <p class="muted" style="margin:6px 0 0">※データは端末内（IndexedDB）に保存。履歴やキャッシュを消しても保持。</p>
  </div>

  <!-- 下：一覧（直近10件） -->
  <div class="card">
    <h3 style="margin:6px 0 10px">📄 一覧（直近10件）</h3>
    <div id="list"></div>
    <p id="empty" class="muted">データなし</p>
  </div>

</div>

<script>
/* ===== IndexedDB 基盤 ===== */
/* v3.7 と同じDB名にして既存データを継続利用 */
const DB_NAME="kakeiboDB_v37";
const STORE="expenses";
let db=null;

function openDB(){
  return new Promise((res,rej)=>{
    const req=indexedDB.open(DB_NAME,1);
    req.onupgradeneeded=e=>{
      const db=e.target.result;
      if(!db.objectStoreNames.contains(STORE)){
        db.createObjectStore(STORE,{keyPath:"id"});
      }
    };
    req.onsuccess=e=>res(e.target.result);
    req.onerror=e=>rej(e.target.error);
  });
}
function idbGetAll(){
  return new Promise((res,rej)=>{
    const tx=db.transaction(STORE,"readonly");
    const st=tx.objectStore(STORE);
    const r=st.getAll();
    r.onsuccess=()=>res(r.result||[]);
    r.onerror=()=>rej(r.error);
  });
}
function idbPut(item){
  return new Promise((res,rej)=>{
    const tx=db.transaction(STORE,"readwrite");
    tx.objectStore(STORE).put(item);
    tx.oncomplete=()=>res();
    tx.onerror=e=>rej(e.target.error);
  });
}
function idbDelete(id){
  return new Promise((res,rej)=>{
    const tx=db.transaction(STORE,"readwrite");
    tx.objectStore(STORE).delete(id);
    tx.oncomplete=()=>res();
    tx.onerror=e=>rej(e.target.error);
  });
}

/* ===== 状態 ===== */
let items=[];           // 全件（内部保持）
let editingId=null;     // 編集中ID（nullで新規）
let dayFilter=null;     // 'YYYY-MM-DD' | null
const yen=n=>`¥${Number(n||0).toLocaleString()}`;
const fmt=(d)=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;

/* ===== UI参照 ===== */
const dt = document.getElementById("dt");
const store = document.getElementById("store");
const cat = document.getElementById("cat");
const amt = document.getElementById("amt");
const listEl = document.getElementById("list");
const emptyEl = document.getElementById("empty");
const sumEl = document.getElementById("summary");
const btnAdd = document.getElementById("btn-add");
const dayInput = document.getElementById("dayFilter");

/* ===== 初期セット ===== */
function setNow(){
  const now=new Date();
  now.setMinutes(now.getMinutes()-now.getTimezoneOffset());
  dt.value = now.toISOString().slice(0,16);
}

/* ===== 描画（一覧 直近10件） ===== */
function renderList(){
  listEl.innerHTML="";
  if(!items.length){ emptyEl.style.display=""; return; }
  emptyEl.style.display="none";
  const latest = [...items].sort((a,b)=>new Date(b.datetime)-new Date(a.datetime)).slice(0,10);
  latest.forEach(it=>{
    const d=new Date(it.datetime);
    const div=document.createElement("div");
    div.className="entry";
    div.innerHTML=`
      <div class="e-left">
        <div><b>${it.store}</b> <small class="badge">${it.category}</small></div>
        <div class="muted">${fmt(d)}</div>
      </div>
      <div style="text-align:right">
        <div style="font-weight:700">${yen(it.amount)}</div>
        <div class="btns" style="margin-top:6px">
          <button class="btn-sub" data-edit="${it.id}">✏️ 編集</button>
          <button class="btn-danger" data-del="${it.id}">削除</button>
        </div>
      </div>
    `;
    listEl.appendChild(div);
  });

  // 削除
  listEl.querySelectorAll("[data-del]").forEach(b=>{
    b.onclick=async()=>{
      const id=Number(b.dataset.del);
      if(!confirm("削除しますか？"))return;
      await idbDelete(id);
      items=items.filter(x=>x.id!==id);
      renderList();
      refreshSummary();
    };
  });
  // 編集
  listEl.querySelectorAll("[data-edit]").forEach(b=>{
    b.onclick=()=>{
      const id=Number(b.dataset.edit);
      const it=items.find(x=>x.id===id);
      if(!it)return;
      editingId=id;
      dt.value = it.datetime;
      store.value = it.store;
      cat.value = it.category;
      amt.value = it.amount;
      btnAdd.textContent="上書き保存";
      window.scrollTo({top:0,behavior:"smooth"});
    };
  });
}

/* ===== 集計 ===== */
function summarize(mode){
  const map={};

  if(mode==="day"){
    if(dayFilter){
      // 任意日指定：その日だけ
      for(const it of items){
        const d=new Date(it.datetime);
        const key=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        if(key===dayFilter){
          map[key]=(map[key]||0)+Number(it.amount||0);
        }
      }
    }else{
      // 直近3日分：最新から日付キー3つ
      const sorted=[...items].sort((a,b)=>new Date(b.datetime)-new Date(a.datetime));
      const picked=new Set();
      for(const it of sorted){
        const d=new Date(it.datetime);
        const key=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        if(picked.size<3 || picked.has(key)){
          picked.add(key);
          map[key]=(map[key]||0)+Number(it.amount||0);
        }
        if(picked.size>=3) continue;
      }
    }
  }else{
    for(const it of items){
      const d=new Date(it.datetime);
      let key="";
      if(mode==="month") key=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
      if(mode==="year")  key=String(d.getFullYear());
      if(mode==="store") key=it.store;
      if(mode==="cat")   key=it.category;
      if(!key) continue;
      map[key]=(map[key]||0)+Number(it.amount||0);
    }
  }

  const keys=Object.keys(map);
  sumEl.innerHTML = keys.length? "" : '<p class="muted">データなし</p>';
  keys.sort((a,b)=>b.localeCompare(a,'ja')).forEach(k=>{
    const row=document.createElement("div");
    row.className="sumline";
    row.innerHTML=`<span>${k}</span><strong>${yen(map[k])}</strong>`;
    sumEl.appendChild(row);
  });
}
let currentTab="day";
function refreshSummary(){ summarize(currentTab); }
function setActive(id){
  document.querySelectorAll(".tabs button").forEach(b=>b.classList.remove("active"));
  if(id) document.getElementById(id).classList.add("active");
}

/* タブ切替 */
document.getElementById("tab-day").onclick   = ()=>{setActive("tab-day"); currentTab="day";   refreshSummary();}
document.getElementById("tab-month").onclick = ()=>{setActive("tab-month");currentTab="month"; refreshSummary();}
document.getElementById("tab-year").onclick  = ()=>{setActive("tab-year"); currentTab="year";  refreshSummary();}
document.getElementById("tab-store").onclick = ()=>{setActive("tab-store");currentTab="store"; refreshSummary();}
document.getElementById("tab-cat").onclick   = ()=>{setActive("tab-cat");  currentTab="cat";   refreshSummary();}
document.getElementById("tab-all").onclick   = ()=>{setActive(""); currentTab="day"; renderList(); refreshSummary();};

/* 日付指定の適用／解除 */
document.getElementById("btn-apply-day").onclick=()=>{
  dayFilter = dayInput.value || null;
  if(currentTab!=="day") { setActive("tab-day"); currentTab="day"; }
  refreshSummary();
};
document.getElementById("btn-clear-day").onclick=()=>{
  dayFilter=null;
  dayInput.value="";
  if(currentTab!=="day") { setActive("tab-day"); currentTab="day"; }
  refreshSummary();
};

/* ===== 入出力 ===== */
document.getElementById("btn-add").onclick=async()=>{
  const datetime=dt.value;
  const s=store.value?.trim();
  const c=cat.value?.trim();
  const a=Number(amt.value);
  if(!datetime||!s||!a){ alert("日付・お店・金額は必須です"); return; }

  if(editingId){
    const it={id:editingId, datetime, store:s, category:c, amount:a};
    await idbPut(it);
    const idx=items.findIndex(x=>x.id===editingId);
    if(idx>-1) items[idx]=it;
    editingId=null;
    btnAdd.textContent="追加";
  }else{
    const it={id:Date.now(), datetime, store:s, category:c, amount:a};
    await idbPut(it);
    items.push(it);
  }
  amt.value="";
  renderList();
  refreshSummary();
};

document.getElementById("btn-clear").onclick=()=>{ amt.value=""; };

document.getElementById("btn-reload").onclick=async()=>{
  items = await idbGetAll();
  renderList();
  refreshSummary();
};

/* ===== CSV（UTF-8+BOM：iPhone Excel対策） ===== */
document.getElementById("btn-export").onclick=()=>{
  if(!items.length){ alert("データなし"); return; }
  const header="id,datetime,store,amount,category\n";
  const rows = items
    .sort((a,b)=>new Date(a.datetime)-new Date(b.datetime))
    .map(it=>[
      it.id,
      it.datetime,
      csvEscape(it.store),
      it.amount,
      csvEscape(it.category)
    ].join(","))
    .join("\n");
  const csv = header + rows;
  const bom = new Uint8Array([0xEF,0xBB,0xBF]); // UTF-8 BOM
  const blob=new Blob([bom, csv],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="kakeibo_backup.csv";
  a.click();
};
function csvEscape(s){ return String(s??"").replaceAll('"','""'); }

document.getElementById("btn-import").onclick=()=>document.getElementById("file-import").click();
document.getElementById("file-import").addEventListener("change",e=>{
  const f=e.target.files?.[0]; if(!f) return;
  const r=new FileReader();
  r.onload=async()=>{
    try{
      const lines=String(r.result).trim().split(/\r?\n/);
      const body=lines.slice(1).filter(Boolean);
      const arr=body.map(l=>{
        const [id,datetime,store,amount,category]=l.split(",");
        return {id:Number(id)||Date.now(), datetime, store, amount:Number(amount)||0, category};
      });
      const tx=db.transaction(STORE,"readwrite");
      const st=tx.objectStore(STORE);
      st.clear();
      arr.forEach(x=>st.put(x));
      tx.oncomplete=async()=>{
        items=await idbGetAll();
        renderList(); refreshSummary();
        alert("CSV読込完了");
      };
    }catch(e){ alert("CSV読込失敗: "+e.message); }
  };
  r.readAsText(f);
});

/* ===== 起動 ===== */
(async()=>{
  db = await openDB();
  items = await idbGetAll();
  setNow();
  renderList();
  refreshSummary();
  if('serviceWorker' in navigator){ navigator.serviceWorker.register('service-worker.js'); }
})();
</script>
</body>
</html>
