<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>å®¶è¨ˆç°¿ v02ï¼ˆDriveé€£æºãƒ»ãƒœã‚¿ãƒ³æ“ä½œï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
  :root{--green:#4caf50;--blue:#2196f3;--red:#e74c3c;--gray:#999;}
  html,body{margin:0;padding:0;font-family:sans-serif;background:#f2f2f2}
  header{background:var(--green);color:#fff;text-align:center;padding:10px;font-size:1.1rem;position:sticky;top:0}
  .container{max-width:520px;margin:0 auto;padding:10px}
  form{display:flex;flex-direction:column;gap:10px;background:#fff;padding:12px;border-radius:10px;box-shadow:0 2px 4px rgba(0,0,0,.08);margin-bottom:12px}
  label{font-size:.9rem;font-weight:700}
  input,select,button{font-size:1rem;padding:10px;border-radius:8px;border:1px solid #ddd}
  .row{display:flex;gap:10px}
  #add-btn{background:var(--green);color:#fff;border:none;flex:1}
  #clear-btn{background:var(--gray);color:#fff;border:none;flex:1}
  .panel{background:#fff;padding:10px;border-radius:10px;box-shadow:0 2px 4px rgba(0,0,0,.08);margin-bottom:12px}
  .panel .row{flex-wrap:wrap}
  .panel button{background:var(--blue);color:#fff;border:none}
  .list{background:#fff;border-radius:10px;box-shadow:0 2px 4px rgba(0,0,0,.08);padding:10px}
  .entry{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #eee;padding:8px 0}
  .entry:last-child{border-bottom:none}
  .entry .meta{font-size:.9rem;line-height:1.4}
  .entry .store{font-weight:700}
  .del-btn{background:var(--red);color:#fff;border:none;padding:6px 10px;border-radius:8px;font-size:.85rem}
  .hint{font-size:.85rem;color:#666;margin-top:4px}
  .sumline{padding:6px 0;border-bottom:1px dashed #eee}
  .sumline:last-child{border-bottom:none}
  .right{float:right;font-weight:700}
</style>
</head>
<body>
<header>å®¶è¨ˆç°¿ v01ï¼ˆDriveé€£æºãƒ»ãƒœã‚¿ãƒ³æ“ä½œï¼‰</header>

<div class="container">

  <!-- å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
  <form id="expense-form">
    <div>
      <label for="datetime">æ—¥ä»˜ã¨æ™‚é–“</label>
      <!-- iPhoneã§ã¯ãƒ€ã‚¤ãƒ¤ãƒ«/ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼UIã«ãªã‚Šã¾ã™ -->
      <input type="datetime-local" id="datetime" required />
    </div>
    <div>
      <label for="store">ãŠåº—</label>
      <select id="store" required>
        <optgroup label="ã‚³ãƒ³ãƒ“ãƒ‹">
          <option>ã‚»ãƒ–ãƒ³ã‚¤ãƒ¬ãƒ–ãƒ³</option><option>ãƒ•ã‚¡ãƒŸãƒªãƒ¼ãƒãƒ¼ãƒˆ</option>
          <option>ãƒ­ãƒ¼ã‚½ãƒ³</option><option>ã¾ã„ã°ã™ã‘ã£ã¨</option>
          <option>ãƒŸãƒ‹ã‚¹ãƒˆãƒƒãƒ—</option><option>ãƒ¤ãƒã‚¶ã‚­</option><option>ãã®ä»–CS</option>
        </optgroup>
        <optgroup label="ã‚¹ãƒ¼ãƒ‘ãƒ¼">
          <option>æ±æ€¥ã‚¹ãƒˆã‚¢</option><option>ãƒãƒ«ã‚¨ãƒ„</option><option>è¥¿å‹</option>
          <option>ãƒ‰ãƒ³ã‚­ãƒ›ãƒ¼ãƒ†</option><option>ãƒ€ã‚¤ã‚¨ãƒ¼</option><option>ä¸‰å’Œ</option><option>ãã®ä»–SP</option>
        </optgroup>
        <optgroup label="ãƒ‰ãƒ©ãƒƒã‚°ã‚¹ãƒˆã‚¢">
          <option>HAC</option><option>ã‚¦ã‚§ãƒ«ã‚·ã‚¢</option><option>ãƒãƒ„ãƒ¢ãƒˆã‚­ãƒ¨ã‚·</option>
          <option>ã‚³ã‚³ã‚«ãƒ©ãƒ•ã‚¡ã‚¤ãƒ³</option><option>ãƒ„ãƒ«ãƒ</option><option>ãã®ä»–DS</option>
        </optgroup>
        <optgroup label="ç™¾å‡">
          <option>ãƒ€ã‚¤ã‚½ãƒ¼</option><option>Seria</option><option>Canâ˜…Do</option><option>ãã®ä»–ç™¾å‡</option>
        </optgroup>
      </select>
    </div>
    <div>
      <label for="amount">é‡‘é¡ï¼ˆå††ï¼‰</label>
      <input type="number" id="amount" inputmode="decimal" required placeholder="ä¾‹: 1250" />
    </div>
    <div class="row">
      <button type="submit" id="add-btn">è¿½åŠ ã™ã‚‹</button>
      <button type="button" id="clear-btn">ã‚¯ãƒªã‚¢</button>
    </div>
    <div class="hint">â€» è¿½åŠ ã™ã‚‹ã¨è‡ªå‹•ã§Google Driveã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚</div>
  </form>

  <!-- æ“ä½œãƒ‘ãƒãƒ« -->
  <div class="panel">
    <div class="row">
      <button id="reload">ğŸ” å†èª­è¾¼</button>
      <button id="show-all">ğŸ“‹ ä¸€è¦§è¡¨ç¤º</button>
      <button id="monthly">ğŸ“† æœˆæ¬¡é›†è¨ˆ</button>
      <button id="yearly">ğŸ“Š å¹´æ¬¡é›†è¨ˆ</button>
    </div>
    <div class="row" style="margin-top:8px">
      <!-- æ—¥åˆ¥çµã‚Šè¾¼ã¿ï¼šãƒ€ã‚¤ãƒ¤ãƒ«/ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼UI -->
      <input type="date" id="date-filter" />
      <button id="filter-date">ğŸ“… æ—¥åˆ¥çµè¾¼</button>

      <!-- åº—èˆ—åˆ¥çµã‚Šè¾¼ã¿ï¼šãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ï¼ˆå‹•çš„ã«å€™è£œç”Ÿæˆï¼‰ -->
      <select id="store-filter" style="flex:1;min-width:140px">
        <option value="">ï¼ˆåº—èˆ—ã‚’é¸æŠï¼‰</option>
      </select>
      <button id="filter-store">ğŸª åº—èˆ—åˆ¥çµè¾¼</button>
    </div>
    <div class="row" style="margin-top:8px">
      <!-- æœˆé¸æŠã§ãã®æœˆã®æ˜ç´°ã‚’è¡¨ç¤º -->
      <input type="month" id="month-filter" />
      <button id="show-month-detail">ğŸ“† æœˆã®æ˜ç´°</button>
    </div>
  </div>

  <!-- çµæœè¡¨ç¤º -->
  <div class="list" id="result">
    <p class="hint">ä¸Šã®ãƒœã‚¿ãƒ³ã§ã€Œä¸€è¦§ã€ã€Œçµã‚Šè¾¼ã¿ã€ã€Œé›†è¨ˆã€ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚</p>
  </div>
</div>

<script>
/* === è¨­å®š === */
const API_URL = "https://script.google.com/macros/s/AKfycbxGiQMrIXr0iLbfUGNsXilKiPnuC-4Zf8ihGHWNw1drOGMmMww_CHsepaCu65jsRy-9MA/exec";

/* === çŠ¶æ…‹ === */
let expenses = []; // { id, datetime, store, amount }

/* === è¦ç´ å–å¾— === */
const form = document.getElementById("expense-form");
const dtInput = document.getElementById("datetime");
const storeInput = document.getElementById("store");
const amountInput = document.getElementById("amount");

const resultDiv = document.getElementById("result");
const dateFilter = document.getElementById("date-filter");
const storeFilter = document.getElementById("store-filter");
const monthFilter = document.getElementById("month-filter");

/* === åˆæœŸãƒ­ãƒ¼ãƒ‰ === */
init();
async function init(){
  await loadData();
  buildStoreFilterOptions();
}

/* === Drive èª­ã¿è¾¼ã¿/ä¿å­˜ === */
async function loadData(){
  try{
    const res = await fetch(API_URL + "?t=" + Date.now()); // ã‚­ãƒ£ãƒƒã‚·ãƒ¥å›é¿
    const data = res.ok ? await res.json() : [];
    expenses = Array.isArray(data) ? data : [];

    // æ—§ãƒ‡ãƒ¼ã‚¿ã«idãŒç„¡ã„å ´åˆã¯ä»˜ä¸ï¼ˆãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
    let changed = false;
    expenses.forEach((e, i) => {
      if (!e.id) { e.id = (new Date(e.datetime).getTime() || Date.now()) + "-" + i; changed = true; }
    });
    if(changed) await saveData(); // ä¸€åº¦ã ã‘è£œæ­£ä¿å­˜
  }catch(e){
    console.error("loadData error:", e);
    expenses = [];
  }
}

async function saveData(){
  try{
    await fetch(API_URL, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(expenses)
    });
  }catch(e){
    console.error("saveData error:", e);
  }
}

/* === å…¥åŠ›ï¼šè¿½åŠ /ã‚¯ãƒªã‚¢ === */
form.addEventListener("submit", async (e)=>{
  e.preventDefault();
  const dt = dtInput.value;
  const st = storeInput.value;
  const amt = parseFloat(amountInput.value);
  if(!dt || !st || !Number.isFinite(amt)) return;

  const entry = { id: Date.now().toString(), datetime: dt, store: st, amount: amt };
  expenses.push(entry);
  await saveData();
  form.reset();
  showAll();             // è¿½åŠ å¾Œã¯ä¸€è¦§ã‚’è‡ªå‹•è¡¨ç¤º
  buildStoreFilterOptions(); // åº—èˆ—ãƒ•ã‚£ãƒ«ã‚¿æ›´æ–°
});

document.getElementById("clear-btn").addEventListener("click", ()=>{
  form.reset();
});

/* === æ“ä½œãƒœã‚¿ãƒ³ === */
document.getElementById("reload").addEventListener("click", async ()=>{
  await loadData();
  buildStoreFilterOptions();
  resultDiv.innerHTML = `<p class="hint">æœ€æ–°ã®ãƒ‡ãƒ¼ã‚¿ã«æ›´æ–°ã—ã¾ã—ãŸã€‚è¡¨ç¤ºã—ãŸã„æ©Ÿèƒ½ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</p>`;
});

document.getElementById("show-all").addEventListener("click", showAll);
document.getElementById("monthly").addEventListener("click", showMonthly);
document.getElementById("yearly").addEventListener("click", showYearly);

document.getElementById("filter-date").addEventListener("click", ()=>{
  const v = dateFilter.value;            // ä¾‹: "2025-10-13"
  if(!v) return;
  showByDate(v);
});

document.getElementById("filter-store").addEventListener("click", ()=>{
  const v = storeFilter.value;
  if(!v) return;
  showByStore(v);
});

document.getElementById("show-month-detail").addEventListener("click", ()=>{
  const v = monthFilter.value;           // ä¾‹: "2025-10"
  if(!v) return;
  showMonthDetail(v);
});

/* === è¡¨ç¤ºï¼ˆä¸€è¦§/çµã‚Šè¾¼ã¿/é›†è¨ˆï¼‰ === */
function showAll(){
  const list = [...expenses].sort((a,b)=>new Date(b.datetime)-new Date(a.datetime));
  renderList(list, "ğŸ“‹ ä¸€è¦§è¡¨ç¤º");
}

function showByDate(dateStr){ // "YYYY-MM-DD"
  const list = expenses.filter(e => (e.datetime || "").startsWith(dateStr))
                       .sort((a,b)=>new Date(b.datetime)-new Date(a.datetime));
  renderList(list, `ğŸ“… æ—¥åˆ¥ï¼š${dateStr}`);
}

function showByStore(store){
  const list = expenses.filter(e => e.store === store)
                       .sort((a,b)=>new Date(b.datetime)-new Date(a.datetime));
  renderList(list, `ğŸª åº—èˆ—åˆ¥ï¼š${store}`);
}

function showMonthDetail(ym){ // "YYYY-MM"
  const list = expenses.filter(e => (e.datetime || "").slice(0,7) === ym)
                       .sort((a,b)=>new Date(b.datetime)-new Date(a.datetime));
  renderList(list, `ğŸ“† æœˆã®æ˜ç´°ï¼š${ym}`);
}

function showMonthly(){
  const m = {};
  for(const e of expenses){
    const d = new Date(e.datetime);
    if (isNaN(d)) continue;
    const ym = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    m[ym] = (m[ym] || 0) + (e.amount||0);
  }
  resultDiv.innerHTML = `<h3>ğŸ“† æœˆæ¬¡é›†è¨ˆ</h3>`;
  const keys = Object.keys(m).sort().reverse();
  if(keys.length===0){ resultDiv.innerHTML += noData(); return; }
  keys.forEach(k=>{
    const line = document.createElement("div");
    line.className="sumline";
    line.innerHTML = `${k}<span class="right">Â¥${m[k].toLocaleString()}</span>`;
    line.addEventListener("click", ()=> showMonthDetail(k)); // ãã®æœˆã‚’ã‚¿ãƒƒãƒ—ã§æ˜ç´°ã¸
    resultDiv.appendChild(line);
  });
}

function showYearly(){
  const y = {};
  for(const e of expenses){
    const d = new Date(e.datetime);
    if (isNaN(d)) continue;
    const yr = d.getFullYear();
    y[yr] = (y[yr] || 0) + (e.amount||0);
  }
  resultDiv.innerHTML = `<h3>ğŸ“Š å¹´æ¬¡é›†è¨ˆ</h3>`;
  const keys = Object.keys(y).sort((a,b)=>b-a);
  if(keys.length===0){ resultDiv.innerHTML += noData(); return; }
  keys.forEach(k=>{
    const line = document.createElement("div");
    line.className="sumline";
    line.innerHTML = `${k}å¹´<span class="right">Â¥${y[k].toLocaleString()}</span>`;
    resultDiv.appendChild(line);
  });
}

/* === å…±é€šæç”» === */
function renderList(list, title){
  resultDiv.innerHTML = `<h3>${title}</h3>`;
  if(list.length===0){ resultDiv.innerHTML += noData(); return; }

  list.forEach(e=>{
    const row = document.createElement("div");
    row.className = "entry";
    row.innerHTML = `
      <div class="meta">
        <div class="store">${escapeHTML(e.store||"")}</div>
        <div>${formatDate(e.datetime)}</div>
        <div>Â¥${(e.amount||0).toLocaleString()}</div>
      </div>
      <button class="del-btn">å‰Šé™¤</button>
    `;
    row.querySelector(".del-btn").addEventListener("click", async ()=>{
      if(!confirm("ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
      // idä¸€è‡´ã§å‰Šé™¤ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šæ—¥æ™‚+é‡‘é¡ä¸€è‡´ï¼‰
      const before = expenses.length;
      expenses = expenses.filter(x => {
        if (e.id && x.id) return x.id !== e.id;
        return !(x.datetime===e.datetime && x.store===e.store && x.amount===e.amount);
      });
      if (expenses.length !== before){
        await saveData();
        // è¡¨ç¤ºä¸­ã®ãƒ¢ãƒ¼ãƒ‰ã‚’ç¶­æŒã—ãŸã¾ã¾å†è¡¨ç¤º
        showAll(); // ã‚·ãƒ³ãƒ—ãƒ«ã«ä¸€è¦§ã¸æˆ»ã™ï¼ˆå¿…è¦ãªã‚‰å…ƒã®listå†æç”»ã«å¤‰æ›´å¯ï¼‰
        buildStoreFilterOptions(); // åº—èˆ—å€™è£œæ›´æ–°
      }
    });
    resultDiv.appendChild(row);
  });
}

function noData(){ return `<p class="hint">è©²å½“ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>`; }

/* === åº—èˆ—ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ï¼ˆå‹•çš„å€™è£œï¼‰ === */
function buildStoreFilterOptions(){
  const set = new Set(expenses.map(e=>e.store).filter(Boolean));
  const cur = storeFilter.value;
  storeFilter.innerHTML = `<option value="">ï¼ˆåº—èˆ—ã‚’é¸æŠï¼‰</option>` + 
    [...set].sort().map(s=>`<option>${escapeHTML(s)}</option>`).join("");
  if ([...set].includes(cur)) storeFilter.value = cur;
}

/* === ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ === */
function formatDate(dtStr){
  const d = new Date(dtStr);
  if (isNaN(d)) return dtStr || "";
  const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), da=String(d.getDate()).padStart(2,'0');
  const hh=String(d.getHours()).padStart(2,'0'), mm=String(d.getMinutes()).padStart(2,'0');
  return `${y}/${m}/${da} ${hh}:${mm}`;
}
function escapeHTML(s){
  return String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]));
}
</script>
</body>
</html>



