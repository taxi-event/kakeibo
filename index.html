<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>📊 家計簿 v3.4</title>
<link rel="manifest" href="manifest.json">
<style>
  html, body { margin: 0; padding: 0; font-family: sans-serif; background: #f2f2f2; }
  header { background: #4caf50; color: #fff; text-align: center; padding: 10px; font-size: 1.2em; }
  .container { max-width: 480px; margin: 0 auto; padding: 10px; }
  form { display: flex; flex-direction: column; gap: 10px; background: white; padding: 12px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 15px; }
  input, select, button { font-size: 1em; padding: 8px; border-radius: 4px; border: 1px solid #ccc; }
  button { cursor: pointer; border: none; }
  .btn-main { background: #4caf50; color: white; }
  .btn-sub { background: #555; color: white; }
  .btn-group { display: flex; flex-wrap: wrap; gap: 6px; justify-content: space-between; }
  .list, .summary { background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); padding: 10px; margin-top: 15px; }
  .entry { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding: 6px 0; }
  .delete-btn { background: #e74c3c; color: white; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 0.8em; }
</style>
</head>
<body>
<header>📊 家計簿 v3.4</header>

<div class="container">
  <form id="expense-form">
    <label>日付と時間</label>
    <input type="datetime-local" id="datetime" required>

    <label>お店</label>
    <input type="text" id="store" placeholder="例：セブンイレブン" required>

    <label>金額（円）</label>
    <input type="number" id="amount" required placeholder="例：1250">

    <label>補足</label>
    <select id="category">
      <option>朝食</option><option>昼食</option><option>夕食</option>
      <option>おやつ</option><option>間食</option><option>飲み物</option>
      <option>ストック</option><option>その他</option>
    </select>

    <div class="btn-group">
      <button type="submit" class="btn-main">追加</button>
      <button type="button" id="clear-btn" class="btn-sub">クリア</button>
      <button type="button" id="reload-btn" class="btn-sub">再読込</button>
    </div>
  </form>

  <div class="btn-group">
    <button id="day-btn">📅 日別</button>
    <button id="month-btn">📆 月別</button>
    <button id="year-btn">📊 年別</button>
    <button id="store-btn">🏪 店別</button>
    <button id="cat-btn">🍱 補足別</button>
  </div>

  <div class="btn-group">
    <button id="export-btn">📤 出力</button>
    <input type="file" id="import-file" accept=".csv" style="display:none;">
    <button id="import-btn">📥 読込</button>
  </div>

  <div id="expense-list" class="list"></div>
  <div class="summary">
    <h3>📈 集計</h3>
    <div id="summary-content"></div>
  </div>
</div>

<script>
let expenses = JSON.parse(localStorage.getItem("kakeibo") || "[]");
renderList();

document.getElementById("expense-form").addEventListener("submit", e => {
  e.preventDefault();
  const datetime = document.getElementById("datetime").value;
  const store = document.getElementById("store").value;
  const amount = parseFloat(document.getElementById("amount").value);
  const category = document.getElementById("category").value;
  if (!datetime || !store || !amount) return;
  expenses.push({ id: Date.now(), datetime, store, amount, category });
  saveData();
  renderList();
  e.target.reset();
});

document.getElementById("clear-btn").onclick = () => document.getElementById("expense-form").reset();
document.getElementById("reload-btn").onclick = () => renderList();

function saveData(){
  localStorage.setItem("kakeibo", JSON.stringify(expenses));
}

function renderList(){
  const list=document.getElementById("expense-list");
  list.innerHTML="";
  if(expenses.length===0){
    list.innerHTML="<p style='text-align:center;color:#666;'>データなし</p>";return;
  }
  expenses.sort((a,b)=>new Date(b.datetime)-new Date(a.datetime))
  .forEach((e,i)=>{
    const div=document.createElement("div");
    div.className="entry";
    div.innerHTML=`<div><b>${e.store}</b><br>${e.category}｜${e.datetime}<br>¥${e.amount.toLocaleString()}</div>
                   <button class="delete-btn" onclick="del(${i})">削除</button>`;
    list.appendChild(div);
  });
}

function del(i){
  if(!confirm("削除しますか？"))return;
  expenses.splice(i,1);saveData();renderList();
}

// --- 集計ボタン
document.getElementById("day-btn").onclick=()=>showSummary("day");
document.getElementById("month-btn").onclick=()=>showSummary("month");
document.getElementById("year-btn").onclick=()=>showSummary("year");
document.getElementById("store-btn").onclick=()=>showSummary("store");
document.getElementById("cat-btn").onclick=()=>showSummary("category");

function showSummary(mode){
  const sumDiv=document.getElementById("summary-content");
  sumDiv.innerHTML="";
  if(expenses.length===0)return;
  const map={};
  for(const e of expenses){
    const d=new Date(e.datetime);
    let key="";
    if(mode==="day") key=`${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`;
    else if(mode==="month") key=`${d.getFullYear()}-${d.getMonth()+1}`;
    else if(mode==="year") key=`${d.getFullYear()}`;
    else if(mode==="store") key=e.store;
    else if(mode==="category") key=e.category;
    map[key]=(map[key]||0)+Number(e.amount);
  }
  Object.keys(map).sort().reverse().forEach(k=>{
    sumDiv.innerHTML+=`${k}：¥${map[k].toLocaleString()}<br>`;
  });
}

// --- CSV出力
document.getElementById("export-btn").onclick=()=>{
  if(expenses.length===0)return alert("データなし");
  const csv="id,datetime,store,amount,category\n"+
    expenses.map(e=>`${e.id},${e.datetime},${e.store},${e.amount},${e.category}`).join("\n");
  const blob=new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="kakeibo_backup.csv";
  a.click();
};

// --- CSV読込
document.getElementById("import-btn").onclick=()=>{
  document.getElementById("import-file").click();
};
document.getElementById("import-file").addEventListener("change",e=>{
  const file=e.target.files[0];
  if(!file)return;
  const reader=new FileReader();
  reader.onload=()=>{
    const lines=reader.result.trim().split("\n").slice(1);
    expenses=lines.map(l=>{
      const [id,datetime,store,amount,category]=l.split(",");
      return {id:Number(id),datetime,store,amount:Number(amount),category};
    });
    saveData();renderList();
    alert("読込完了");
  };
  reader.readAsText(file);
});

if('serviceWorker' in navigator){
  navigator.serviceWorker.register('service-worker.js');
}
</script>
</body>
</html>
