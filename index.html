<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ğŸ“Š å®¶è¨ˆç°¿ v3.8ï¼ˆæ—¥ä»˜æŒ‡å®šé›†è¨ˆï¼‰</title>
<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#4CAF50" />
<style>
  :root{--g:#4caf50;--dx:#e74c3c;--bg:#f6f6f6;--ink:#222}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  header{position:sticky;top:0;z-index:10;background:var(--g);color:#fff;padding:10px 14px;font-weight:700;display:flex;align-items:center;gap:8px}
  .wrap{max-width:520px;margin:0 auto;padding:12px}
  .card{background:#fff;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.08);padding:12px;margin:12px 0}
  label{font-size:.9em;font-weight:700;display:block;margin:8px 0 4px}
  input,select,button{width:100%;font-size:16px;padding:10px;border:1px solid #ddd;border-radius:10px;box-sizing:border-box}
  button{cursor:pointer;border:none}
  .btn-main{background:var(--g);color:#fff}
  .btn-sub{background:#555;color:#fff}
  .btn-danger{background:var(--dx);color:#fff}
  .btns{display:flex;gap:8px;flex-wrap:wrap}
  .tabs{display:flex;gap:8px;flex-wrap:wrap}
  .tabs button{flex:1 1 30%;background:#eee}
  .tabs button.active{background:#d7f3dc}
  .sumline{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px dashed #eee}
  .sumline:last-child{border-bottom:none}
  .entry{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #eee;padding:10px 0}
  .entry:last-child{border-bottom:none}
  .e-left{max-width:74%}
  .muted{color:#777}
  small.badge{background:#eee;border-radius:999px;padding:2px 8px;margin-left:6px}
  .inline{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .inline input[type="date"]{flex:1}
  .pill{background:#eef7f0;color:#1b5e20;padding:4px 8px;border-radius:999px;font-size:12px}
</style>
</head>
<body>
<header>ğŸ“Š å®¶è¨ˆç°¿ v3.8ï¼ˆã‚¹ãƒãƒ›å˜ä½“ï¼‰</header>
<div class="wrap">

  <!-- ä¸Šï¼šé›†è¨ˆï¼ˆã‚¿ãƒ–ï¼‹æ—¥ä»˜æŒ‡å®šï¼‰ -->
  <div class="card">
    <div class="tabs">
      <button id="tab-day"   class="active">ğŸ“… æ—¥åˆ¥</button>
      <button id="tab-month">ğŸ“† æœˆåˆ¥</button>
      <button id="tab-year">ğŸ“Š å¹´åˆ¥</button>
      <button id="tab-store">ğŸª åº—åˆ¥</button>
      <button id="tab-cat">ğŸ± è£œè¶³åˆ¥</button>
      <button id="tab-all">ğŸ” å…¨ä»¶</button>
    </div>

    <!-- æ—¥ä»˜æŒ‡å®šUIï¼ˆã€Œæ—¥åˆ¥ã€ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ™‚ã®ã¿ä½¿ã†ï¼‰ -->
    <div class="inline" style="margin-top:8px">
      <span class="pill">ä»»æ„æ—¥é›†è¨ˆ</span>
      <input id="dayFilter" type="date" />
      <button id="btn-apply-day" class="btn-sub" style="flex:0 0 auto">é©ç”¨</button>
      <button id="btn-clear-day" class="btn-sub" style="flex:0 0 auto">è§£é™¤</button>
    </div>

    <div id="summary" style="margin-top:8px"></div>
    <p class="muted" style="margin:6px 0 0">â€»æ—¥ä»˜æœªæŒ‡å®šæ™‚ã¯ã€Œç›´è¿‘3æ—¥åˆ†ã€ã‚’è‡ªå‹•é›†è¨ˆ</p>
  </div>

  <!-- ä¸­ï¼šå…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
  <div class="card">
    <label for="dt">æ—¥ä»˜ã¨æ™‚é–“</label>
    <input id="dt" type="datetime-local" />

    <label for="store">ãŠåº—</label>
    <select id="store" required>
      <optgroup label="ã‚³ãƒ³ãƒ“ãƒ‹">
        <option>ã‚»ãƒ–ãƒ³ã‚¤ãƒ¬ãƒ–ãƒ³</option><option>ãƒ•ã‚¡ãƒŸãƒªãƒ¼ãƒãƒ¼ãƒˆ</option><option>ãƒ­ãƒ¼ã‚½ãƒ³</option>
        <option>ã¾ã„ã°ã™ã‘ã£ã¨</option><option>ãƒŸãƒ‹ã‚¹ãƒˆãƒƒãƒ—</option><option>ãƒ¤ãƒã‚¶ã‚­</option><option>ãã®ä»–CS</option>
      </optgroup>
      <optgroup label="ã‚¹ãƒ¼ãƒ‘ãƒ¼">
        <option>æ±æ€¥ã‚¹ãƒˆã‚¢</option><option>ãƒãƒ«ã‚¨ãƒ„</option><option>è¥¿å‹</option><option>ãƒ‰ãƒ³ã‚­ãƒ›ãƒ¼ãƒ†</option><option>ãƒ€ã‚¤ã‚¨ãƒ¼</option><option>ä¸‰å’Œ</option><option>ãã®ä»–SP</option>
      </optgroup>
      <optgroup label="ãƒ‰ãƒ©ãƒƒã‚°ã‚¹ãƒˆã‚¢">
        <option>HAC</option><option>ã‚¦ã‚§ãƒ«ã‚·ã‚¢</option><option>ãƒãƒ„ãƒ¢ãƒˆã‚­ãƒ¨ã‚·</option><option>ã‚³ã‚³ã‚«ãƒ©ãƒ•ã‚¡ã‚¤ãƒ³</option><option>ãƒ„ãƒ«ãƒ</option><option>ãã®ä»–DS</option>
      </optgroup>
      <optgroup label="ç™¾å‡">
        <option>ãƒ€ã‚¤ã‚½ãƒ¼</option><option>Seria</option><option>Canâ˜…Do</option><option>ãã®ä»–ç™¾å‡</option>
      </optgroup>
    </select>

    <label for="cat">è£œè¶³</label>
    <select id="cat">
      <option>æœé£Ÿ</option><option>æ˜¼é£Ÿ</option><option>å¤•é£Ÿ</option>
      <option>ãŠã‚„ã¤</option><option>é–“é£Ÿ</option><option>é£²ã¿ç‰©</option>
      <option>ã‚¹ãƒˆãƒƒã‚¯</option><option>ãã®ä»–</option>
    </select>

    <label for="amt">é‡‘é¡ï¼ˆå††ï¼‰</label>
    <input id="amt" type="number" inputmode="decimal" placeholder="ä¾‹ï¼š1250" />

    <div class="btns" style="margin-top:10px">
      <button id="btn-add" class="btn-main">è¿½åŠ </button>
      <button id="btn-clear" class="btn-sub">ã‚¯ãƒªã‚¢</button>
      <button id="btn-reload" class="btn-sub">å†èª­è¾¼</button>
    </div>

    <div class="btns" style="margin-top:8px">
      <button id="btn-export" class="btn-sub">ğŸ“¤ CSVå‡ºåŠ›</button>
      <input id="file-import" type="file" accept=".csv" style="display:none" />
      <button id="btn-import" class="btn-sub">ğŸ“¥ CSVèª­è¾¼</button>
    </div>
    <p class="muted" style="margin:6px 0 0">â€»ãƒ‡ãƒ¼ã‚¿ã¯ç«¯æœ«å†…ï¼ˆIndexedDBï¼‰ã«ä¿å­˜ã€‚å±¥æ­´ã‚„ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ¶ˆã—ã¦ã‚‚ä¿æŒã€‚</p>
  </div>

  <!-- ä¸‹ï¼šä¸€è¦§ï¼ˆç›´è¿‘10ä»¶ï¼‰ -->
  <div class="card">
    <h3 style="margin:6px 0 10px">ğŸ“„ ä¸€è¦§ï¼ˆç›´è¿‘10ä»¶ï¼‰</h3>
    <div id="list"></div>
    <p id="empty" class="muted">ãƒ‡ãƒ¼ã‚¿ãªã—</p>
  </div>

</div>

<script>
/* ===== IndexedDB åŸºç›¤ ===== */
/* v3.7 ã¨åŒã˜DBåã«ã—ã¦æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ç¶™ç¶šåˆ©ç”¨ */
const DB_NAME="kakeiboDB_v37";
const STORE="expenses";
let db=null;

function openDB(){
  return new Promise((res,rej)=>{
    const req=indexedDB.open(DB_NAME,1);
    req.onupgradeneeded=e=>{
      const db=e.target.result;
      if(!db.objectStoreNames.contains(STORE)){
        db.createObjectStore(STORE,{keyPath:"id"});
      }
    };
    req.onsuccess=e=>res(e.target.result);
    req.onerror=e=>rej(e.target.error);
  });
}
function idbGetAll(){
  return new Promise((res,rej)=>{
    const tx=db.transaction(STORE,"readonly");
    const st=tx.objectStore(STORE);
    const r=st.getAll();
    r.onsuccess=()=>res(r.result||[]);
    r.onerror=()=>rej(r.error);
  });
}
function idbPut(item){
  return new Promise((res,rej)=>{
    const tx=db.transaction(STORE,"readwrite");
    tx.objectStore(STORE).put(item);
    tx.oncomplete=()=>res();
    tx.onerror=e=>rej(e.target.error);
  });
}
function idbDelete(id){
  return new Promise((res,rej)=>{
    const tx=db.transaction(STORE,"readwrite");
    tx.objectStore(STORE).delete(id);
    tx.oncomplete=()=>res();
    tx.onerror=e=>rej(e.target.error);
  });
}

/* ===== çŠ¶æ…‹ ===== */
let items=[];           // å…¨ä»¶ï¼ˆå†…éƒ¨ä¿æŒï¼‰
let editingId=null;     // ç·¨é›†ä¸­IDï¼ˆnullã§æ–°è¦ï¼‰
let dayFilter=null;     // 'YYYY-MM-DD' | null
const yen=n=>`Â¥${Number(n||0).toLocaleString()}`;
const fmt=(d)=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;

/* ===== UIå‚ç…§ ===== */
const dt = document.getElementById("dt");
const store = document.getElementById("store");
const cat = document.getElementById("cat");
const amt = document.getElementById("amt");
const listEl = document.getElementById("list");
const emptyEl = document.getElementById("empty");
const sumEl = document.getElementById("summary");
const btnAdd = document.getElementById("btn-add");
const dayInput = document.getElementById("dayFilter");

/* ===== åˆæœŸã‚»ãƒƒãƒˆ ===== */
function setNow(){
  const now=new Date();
  now.setMinutes(now.getMinutes()-now.getTimezoneOffset());
  dt.value = now.toISOString().slice(0,16);
}

/* ===== æç”»ï¼ˆä¸€è¦§ ç›´è¿‘10ä»¶ï¼‰ ===== */
function renderList(){
  listEl.innerHTML="";
  if(!items.length){ emptyEl.style.display=""; return; }
  emptyEl.style.display="none";
  const latest = [...items].sort((a,b)=>new Date(b.datetime)-new Date(a.datetime)).slice(0,10);
  latest.forEach(it=>{
    const d=new Date(it.datetime);
    const div=document.createElement("div");
    div.className="entry";
    div.innerHTML=`
      <div class="e-left">
        <div><b>${it.store}</b> <small class="badge">${it.category}</small></div>
        <div class="muted">${fmt(d)}</div>
      </div>
      <div style="text-align:right">
        <div style="font-weight:700">${yen(it.amount)}</div>
        <div class="btns" style="margin-top:6px">
          <button class="btn-sub" data-edit="${it.id}">âœï¸ ç·¨é›†</button>
          <button class="btn-danger" data-del="${it.id}">å‰Šé™¤</button>
        </div>
      </div>
    `;
    listEl.appendChild(div);
  });

  // å‰Šé™¤
  listEl.querySelectorAll("[data-del]").forEach(b=>{
    b.onclick=async()=>{
      const id=Number(b.dataset.del);
      if(!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ"))return;
      await idbDelete(id);
      items=items.filter(x=>x.id!==id);
      renderList();
      refreshSummary();
    };
  });
  // ç·¨é›†
  listEl.querySelectorAll("[data-edit]").forEach(b=>{
    b.onclick=()=>{
      const id=Number(b.dataset.edit);
      const it=items.find(x=>x.id===id);
      if(!it)return;
      editingId=id;
      dt.value = it.datetime;
      store.value = it.store;
      cat.value = it.category;
      amt.value = it.amount;
      btnAdd.textContent="ä¸Šæ›¸ãä¿å­˜";
      window.scrollTo({top:0,behavior:"smooth"});
    };
  });
}

/* ===== é›†è¨ˆ ===== */
function summarize(mode){
  const map={};

  if(mode==="day"){
    if(dayFilter){
      // ä»»æ„æ—¥æŒ‡å®šï¼šãã®æ—¥ã ã‘
      for(const it of items){
        const d=new Date(it.datetime);
        const key=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        if(key===dayFilter){
          map[key]=(map[key]||0)+Number(it.amount||0);
        }
      }
    }else{
      // ç›´è¿‘3æ—¥åˆ†ï¼šæœ€æ–°ã‹ã‚‰æ—¥ä»˜ã‚­ãƒ¼3ã¤
      const sorted=[...items].sort((a,b)=>new Date(b.datetime)-new Date(a.datetime));
      const picked=new Set();
      for(const it of sorted){
        const d=new Date(it.datetime);
        const key=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        if(picked.size<3 || picked.has(key)){
          picked.add(key);
          map[key]=(map[key]||0)+Number(it.amount||0);
        }
        if(picked.size>=3) continue;
      }
    }
  }else{
    for(const it of items){
      const d=new Date(it.datetime);
      let key="";
      if(mode==="month") key=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
      if(mode==="year")  key=String(d.getFullYear());
      if(mode==="store") key=it.store;
      if(mode==="cat")   key=it.category;
      if(!key) continue;
      map[key]=(map[key]||0)+Number(it.amount||0);
    }
  }

  const keys=Object.keys(map);
  sumEl.innerHTML = keys.length? "" : '<p class="muted">ãƒ‡ãƒ¼ã‚¿ãªã—</p>';
  keys.sort((a,b)=>b.localeCompare(a,'ja')).forEach(k=>{
    const row=document.createElement("div");
    row.className="sumline";
    row.innerHTML=`<span>${k}</span><strong>${yen(map[k])}</strong>`;
    sumEl.appendChild(row);
  });
}
let currentTab="day";
function refreshSummary(){ summarize(currentTab); }
function setActive(id){
  document.querySelectorAll(".tabs button").forEach(b=>b.classList.remove("active"));
  if(id) document.getElementById(id).classList.add("active");
}

/* ã‚¿ãƒ–åˆ‡æ›¿ */
document.getElementById("tab-day").onclick   = ()=>{setActive("tab-day"); currentTab="day";   refreshSummary();}
document.getElementById("tab-month").onclick = ()=>{setActive("tab-month");currentTab="month"; refreshSummary();}
document.getElementById("tab-year").onclick  = ()=>{setActive("tab-year"); currentTab="year";  refreshSummary();}
document.getElementById("tab-store").onclick = ()=>{setActive("tab-store");currentTab="store"; refreshSummary();}
document.getElementById("tab-cat").onclick   = ()=>{setActive("tab-cat");  currentTab="cat";   refreshSummary();}
document.getElementById("tab-all").onclick   = ()=>{setActive(""); currentTab="day"; renderList(); refreshSummary();};

/* æ—¥ä»˜æŒ‡å®šã®é©ç”¨ï¼è§£é™¤ */
document.getElementById("btn-apply-day").onclick=()=>{
  dayFilter = dayInput.value || null;
  if(currentTab!=="day") { setActive("tab-day"); currentTab="day"; }
  refreshSummary();
};
document.getElementById("btn-clear-day").onclick=()=>{
  dayFilter=null;
  dayInput.value="";
  if(currentTab!=="day") { setActive("tab-day"); currentTab="day"; }
  refreshSummary();
};

/* ===== å…¥å‡ºåŠ› ===== */
document.getElementById("btn-add").onclick=async()=>{
  const datetime=dt.value;
  const s=store.value?.trim();
  const c=cat.value?.trim();
  const a=Number(amt.value);
  if(!datetime||!s||!a){ alert("æ—¥ä»˜ãƒ»ãŠåº—ãƒ»é‡‘é¡ã¯å¿…é ˆã§ã™"); return; }

  if(editingId){
    const it={id:editingId, datetime, store:s, category:c, amount:a};
    await idbPut(it);
    const idx=items.findIndex(x=>x.id===editingId);
    if(idx>-1) items[idx]=it;
    editingId=null;
    btnAdd.textContent="è¿½åŠ ";
  }else{
    const it={id:Date.now(), datetime, store:s, category:c, amount:a};
    await idbPut(it);
    items.push(it);
  }
  amt.value="";
  renderList();
  refreshSummary();
};

document.getElementById("btn-clear").onclick=()=>{ amt.value=""; };

document.getElementById("btn-reload").onclick=async()=>{
  items = await idbGetAll();
  renderList();
  refreshSummary();
};

/* ===== CSVï¼ˆUTF-8+BOMï¼šiPhone Excelå¯¾ç­–ï¼‰ ===== */
document.getElementById("btn-export").onclick=()=>{
  if(!items.length){ alert("ãƒ‡ãƒ¼ã‚¿ãªã—"); return; }
  const header="id,datetime,store,amount,category\n";
  const rows = items
    .sort((a,b)=>new Date(a.datetime)-new Date(b.datetime))
    .map(it=>[
      it.id,
      it.datetime,
      csvEscape(it.store),
      it.amount,
      csvEscape(it.category)
    ].join(","))
    .join("\n");
  const csv = header + rows;
  const bom = new Uint8Array([0xEF,0xBB,0xBF]); // UTF-8 BOM
  const blob=new Blob([bom, csv],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="kakeibo_backup.csv";
  a.click();
};
function csvEscape(s){ return String(s??"").replaceAll('"','""'); }

document.getElementById("btn-import").onclick=()=>document.getElementById("file-import").click();
document.getElementById("file-import").addEventListener("change",e=>{
  const f=e.target.files?.[0]; if(!f) return;
  const r=new FileReader();
  r.onload=async()=>{
    try{
      const lines=String(r.result).trim().split(/\r?\n/);
      const body=lines.slice(1).filter(Boolean);
      const arr=body.map(l=>{
        const [id,datetime,store,amount,category]=l.split(",");
        return {id:Number(id)||Date.now(), datetime, store, amount:Number(amount)||0, category};
      });
      const tx=db.transaction(STORE,"readwrite");
      const st=tx.objectStore(STORE);
      st.clear();
      arr.forEach(x=>st.put(x));
      tx.oncomplete=async()=>{
        items=await idbGetAll();
        renderList(); refreshSummary();
        alert("CSVèª­è¾¼å®Œäº†");
      };
    }catch(e){ alert("CSVèª­è¾¼å¤±æ•—: "+e.message); }
  };
  r.readAsText(f);
});

/* ===== èµ·å‹• ===== */
(async()=>{
  db = await openDB();
  items = await idbGetAll();
  setNow();
  renderList();
  refreshSummary();
  if('serviceWorker' in navigator){ navigator.serviceWorker.register('service-worker.js'); }
})();
</script>
</body>
</html>
